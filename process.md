# KubeMinds 项目状态分析报告

## 1. 概述

KubeMinds 目前处于 **MVP (Minimum Viable Product)** 阶段，已经实现了核心的 "Operator 调度 -> Agent 诊断 -> LLM 推理 -> 工具执行" 闭环。代码结构简洁清晰，遵循了 Go 标准布局，但距离 Roadmap 中规划的 Phase 2 (Enhanced Diagnosis & Knowledge Base) 还有较大差距。

## 2. 现状分析 (As-Is)

### 2.1 核心功能
*   **Controller**: `DiagnosisTaskReconciler` 实现了基本的 CRD 监听和状态流转 (Pending -> Running -> Completed/Failed)。
*   **Agent Engine**: `BaseAgent` 实现了简单的 ReAct (Think-Act-Observe) 循环，支持最大步数限制。
*   **LLM Integration**: 仅支持 OpenAI 接口，硬编码了 `sashabaranov/go-openai` 客户端，暂无多模型适配层。
*   **Tools**: 实现了三个基础 K8s 工具：
    *   `get_pod_logs`: 获取 Pod 日志 (硬编码 tail=100)。
    *   `get_pod_events`: 获取 Pod 事件。
    *   `get_pod_spec`: 获取 Pod Spec (移除了 managedFields)。
*   **Memory**: 仅实现了 `L1 Memory` (In-Memory slice)，无持久化，无上下文压缩。

### 2.2 代码结构
```text
internal/
├── agent/       # 核心循环，目前逻辑较简单
├── controller/  # 标准 Operator 模式，使用 goroutine 启动 Agent
├── llm/         # 仅 OpenAI 实现，无 Provider 抽象工厂
└── tools/       # 简单的 struct 实现 Tool 接口
```

## 3. 差距分析 (Gap Analysis: MVP vs Phase 2)

| 模块 | MVP 现状 (Current) | Phase 2 目标 (Target) | 差距 (Gap) |
|---|---|---|---|
| **状态管理** | 无状态，Operator 重启即丢失进度 | **Light Checkpoint**: 保存阶段性 Findings | **Critical**: 需在 Agent Loop 中提取 Findings 并更新到 CRD Status |
| **技能引擎** | 无，纯 Prompt | **Skill Engine**: Domain Skill + 决策树 | **Critical**: 缺少 Skill 定义、匹配逻辑和决策树注入机制 |
| **工具体系** | 直接 Go 函数调用 | **Unified Tool Router**: gRPC + MCP | **High**: 需重构 Tool 接口支持远程调用和 MCP 协议 |
| **记忆系统** | L1 内存切片 | **L2/L3 Memory**: Redis/PGVector | **Medium**: 需引入外部存储适配器 |
| **LLM 适配** | 仅 OpenAI | **LLM Router**: 大小模型分流 (Ollama/GPT-4) | **Medium**: 需抽象 LLMProvider 并实现路由逻辑 |
| **安全性** | 无检查 | **Safety Level**: 读写分离，审批流 | **High**: 缺少操作安全分级和审批状态处理 |

## 4. 下一步计划 (Action Plan)

建议优先攻克 **Checkpoint** 和 **Skill Engine**，解决生产环境可用性问题。

### Step 1: 实现 Light Checkpoint (解决 Context 溢出与断点恢复)
1.  **修改 CRD**: 在 `DiagnosisTaskStatus` 中增加 `Checkpoint` 字段 (`[]Finding`)。
2.  **增强 Agent**:
    *   定义 `Finding` 结构。
    *   在 `Act` 阶段后，解析工具结果，提取摘要生成 `Finding`。
    *   通过回调函数将 `Finding` 实时更新到 CRD。
3.  **恢复机制**: Agent 启动时检查 CRD 中的 `Checkpoint`，将其转换为 System Prompt 注入 LLM。

### Step 2: 引入 Skill Engine (提升诊断准确率)
1.  **定义 Skill**: 创建 `Skill` 结构体 (YAML -> Go struct)，包含 `SystemPrompt` 和 `DecisionTree`。
2.  **实现 Matcher**: 在 Controller 中根据 Alert Labels 匹配 Skill。
3.  **注入 Agent**: 将匹配到的 Skill (主要是 Prompt 和工具白名单) 传递给 Agent。

### Step 3: 安全性增强
1.  **Tool Safety**: 为每个 Tool 增加 `SafetyLevel` (ReadOnly/Risk/Forbidden)。
2.  **Approval Flow**: 遇到 Risk 操作时，Agent 挂起并更新 Status 为 `WaitingApproval`。

---
*Generated by Claude Code*
