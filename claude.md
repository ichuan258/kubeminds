# KubeMinds 项目开发指南 (MVP)

此文件定义了 KubeMinds 项目的上下文、技术标准和开发规范。Claude 在执行任务前应优先读取此文件。

## 1. 项目概述

**KubeMinds** 是一个 K8s-Native 的 AIOps Agent 平台。
*   **核心目标**: 降低 K8s 故障排查时间 (MTTR)。
*   **MVP 范围**: 实现 "CRD 触发 -> Agent 诊断 -> LLM 推理 -> 工具执行 -> 结果反馈" 的核心闭环。
*   **运行模式**: 作为 K8s Operator 部署，监听 `DiagnosisTask` CR，启动 Ephemeral Agent Loop 进行诊断。

## 2. 技术栈与依赖

*   **语言**: Go 1.22+
*   **核心框架**:
    *   `sigs.k8s.io/controller-runtime`: Operator 核心逻辑。
    *   `k8s.io/client-go`: K8s API 交互。
    *   `github.com/sashabaranov/go-openai`: LLM 客户端 (兼容 OpenAI 协议)。
    *   **多模型支持**: 设计统一接口 `LLMProvider`，支持 OpenAI, Gemini, Kimi (Moonshot), DeepSeek 等。
*   **数据存储**:
    *   CRD Status (Etcd): 任务状态、最终报告。
    *   In-Memory (MVP): Agent 运行时的短期记忆 (Context)。
*   **构建工具**: `Make`, `Kustomize`, `Docker`.

## 3. 代码风格规范

遵循 **Uber Go Style Guide**，并补充以下特定规则：

### 3.1 错误处理
*   **必须 Wrap**: 禁止直接返回 error，必须添加上下文。
    *   *Bad*: `return err`
    *   *Good*: `return fmt.Errorf("failed to list pods in namespace %s: %w", ns, err)`
*   **定义明确**: 在 `internal/pkg/errors` 中定义特定业务错误类型（如 `ErrLLMContextExceeded`, `ErrToolExecutionFailed`）。

### 3.2 并发与 Context
*   **Context 传递**: 所有长时间运行的函数（Agent Loop, LLM Call, K8s API）必须接受 `context.Context`。
*   **Goroutine**: 禁止裸起 Goroutine，必须使用 `errgroup` 或 `WaitHeader` 管理生命周期，确保能响应 Cancel 信号。

### 3.3 日志规范
*   使用 `logr` 结构化日志。
*   **Controller 层**: 记录调谐事件 (Reconciling, Reconciled)。
*   **Agent 层**: 记录思考步骤 (Thinking, Acting, Observing)。
    ```go
    log.Info("executing tool", "tool", "get_pod_logs", "step", 3)
    ```

### 3.4 K8s Operator 规范
*   **Status 更新**: 仅在 `Reconcile` 结束或状态发生实质变化时更新 Status。
*   **幂等性**: 确保所有 Side Effect (如创建 Pod) 都是幂等的。

### 3.5 配置管理
*   **分层策略**: 遵循 `YAML (默认值) -> Flag (覆盖) -> Env (敏感信息)` 的优先级。
*   **位置**:
    *   配置结构体定义在 `internal/config`。
    *   默认配置文件放在 `cmd/config/config.yaml`。

## 4. 目录结构说明 (Phase 2)

```text
kubeminds/
├── api/v1alpha1/           # CRD 定义 (DiagnosisTask)
├── cmd/
│   ├── manager/            # 入口文件
│   └── config/             # 默认配置文件 (config.yaml)
├── internal/
│   ├── config/             # 配置加载逻辑
│   ├── controller/         # Reconcile 逻辑 (调度 Agent)
│   ├── agent/              # 核心业务逻辑
│   │   ├── engine.go       # ReAct Loop (Think-Act-Observe) + Checkpoint
│   │   ├── memory.go       # 上下文管理 (L1)
│   │   ├── types.go        # 内部数据结构 (Agent Interface)
│   │   └── skill_manager.go# [Todo] Skill Engine 实现
│   ├── llm/                # LLM 接口封装 (Prompt 管理, Token 计算)
│   │   ├── prompts/        # [Todo] Prompt 模板
│   └── tools/              # 工具实现 (GetLogs, GetEvents, GetSpec)
└── docs/iterations/        # 设计文档与迭代记录
    ├── mvp/                # Phase 1: MVP
    └── phase2/             # Phase 2: Checkpoint & Skill
```

## 5. 开发流程规则

1.  **Plan First**:
    *   涉及多个文件修改或架构调整的任务，**必须**先使用 Plan Mode 进行规划。
2.  **先设计后编码 (Think before Code)**:
    *   修改复杂逻辑前，先在对话中用伪代码或流程图确认方案。
    *   涉及 CRD 字段变更时，必须先更新 `api/` 定义并运行 `make manifests` (如果环境支持) 或手动更新 `zz_generated`。
3.  **模块化开发**:
    *   Agent 的每个 Tool 必须是独立的函数或 Struct，实现统一的 `Tool` 接口。
    *   **Go Standard Layout**: `cmd/` 下仅存放 `main.go` 和入口配置，业务逻辑必须放入 `internal/`。
4.  **安全性检查**:
    *   **ReadOnly**: 读操作 (Logs, Events) 可自动执行。
    *   **Write**: 写操作 (Delete, Scale) 在 MVP 阶段必须返回 `RequiresApproval` 状态（模拟）。
5.  **State Management (New in Phase 2)**:
    *   Agent 必须支持 Checkpoint，在 Crash 后能从 CRD Status 恢复上下文。
    *   严禁在 Controller 内存中维护长期状态。

## 6. 测试要求

*   **单元测试 (Unit Test)**:
    *   覆盖率目标: 核心业务逻辑 > 80%。
    *   重点覆盖: `internal/agent/engine.go` (Mock LLM 和 Tools)。
    *   工具类测试: 使用 Fake Client (`k8s.io/client-go/kubernetes/fake`) 测试 K8s 工具。
*   **集成测试 (EnvTest)**:
    *   使用 `controller-runtime/pkg/envtest` 启动本地 API Server。
    *   测试 Controller 对 CRD 创建、更新、删除的响应。
*   **E2E 测试 (Kind)**:
    *   在 Kind 集群中部署 Operator，模拟真实故障（如 OOM），验证 Agent 能否生成报告。

## 7. Git 工作流

*   **分支策略**: 单主干 (main)，功能分支 (feat/xxx, fix/xxx)。
*   **Commit Message**: 遵循 Conventional Commits。
    *   `feat: add pod log tool`
    *   `fix: resolve nil pointer in agent loop`
    *   `docs: update mvp architecture`
    *   `refactor: optimize prompt structure`

## 8. MVP 阶段特别说明

*   **不做**: 复杂的 RAG (Postgres/Redis)，复杂的 RBAC，多集群支持。
*   **专注**: 跑通 `DiagnosisTask` 创建到 `Status.Report` 生成的全流程。
*   **LLM 配置**: MVP 需支持多 API 接入。
    *   **配置文件**: `cmd/config/config.yaml`
    *   **关键字段**:
        *   `apiKey`: LLM API Key (也可通过 `OPENAI_API_KEY` 环境变量设置)。
        *   `model`: 模型名称 (e.g., `gpt-4o`, `gemini-1.5-pro`)。
        *   `baseUrl`: API 基础路径 (e.g., `https://api.openai.com/v1`, `http://localhost:8080/v1`)。

---
*Generated by Claude Code for KubeMinds MVP*
